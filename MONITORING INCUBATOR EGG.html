<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>IoT Monitoring System</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 0; padding: 20px; }
        h1 { text-align: center; margin-bottom: 10px; }
        .alert-counter { text-align: center; font-size: 1.2em; margin-bottom: 20px; font-weight: bold; color: red; }
        .cards { display: flex; justify-content: center; gap: 20px; margin-bottom: 40px; flex-wrap: wrap; }
        .card { background: #fff; padding: 20px; border-radius: 10px; width: 180px; text-align: center; box-shadow: 0 0 10px rgba(0,0,0,0.1); transition: 0.3s; }
        .card h2 { margin: 10px 0; font-size: 2em; }
        .chart-container { width: 80%; max-width: 800px; margin: 20px auto; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1);}
    </style>
</head>
<body>
    <h1>IoT Monitoring System</h1>
    <div class="alert-counter" id="alertCount">Current Alerts: 0</div>

    <!-- Latest Values Cards -->
    <div class="cards">
        <div class="card" id="tempCard">
            <h4>Temperature</h4>
            <h2 id="latestTemp">-- °C</h2>
        </div>
        <div class="card" id="humCard">
            <h4>Humidity</h4>
            <h2 id="latestHum">-- %</h2>
        </div>
    </div>

    <!-- Charts -->
    <div class="chart-container">
        <canvas id="temperatureChart"></canvas>
    </div>
    <div class="chart-container">
        <canvas id="humidityChart"></canvas>
    </div>

    <script>
        const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRygk6rsDcpdeupU698H9MvQxT9sN9G4QkQJ6UwfSRXUSY4M5vfcDGrQzbpiE0ZGL_zXPEToCoMyNut/pub?output=csv";

        const tempMin = 20;
        const tempMax = 38;
        const humMin = 50;
        const humMax = 80;

        let temperatureChart, humidityChart;

        async function fetchSheetData() {
            const response = await fetch(sheetURL);
            const data = await response.text();
            const rows = data.split("\n").slice(1);

            const time = [], temperature = [], humidity = [];

            rows.forEach(row => {
                const cols = row.split(",").map(col => col.trim());
                if(cols.length >= 4 && cols[0] && cols[1] && cols[2] && cols[3]) {
                    time.push(cols[0] + " " + cols[1]);
                    temperature.push(parseFloat(cols[2]));
                    humidity.push(parseFloat(cols[3]));
                }
            });

            return { time, temperature, humidity };
        }

        async function updateDashboard() {
            const data = await fetchSheetData();
            if(data.temperature.length === 0) return;

            const latestTemp = data.temperature[data.temperature.length-1];
            const latestHum = data.humidity[data.humidity.length-1];

            // Update latest values
            document.getElementById('latestTemp').textContent = latestTemp + " °C";
            document.getElementById('latestHum').textContent = latestHum + " %";

            // Check alerts
            let alertCount = 0;

            // Temperature card
            const tempCard = document.getElementById('tempCard');
            if(latestTemp < tempMin || latestTemp > tempMax){
                tempCard.style.backgroundColor = "#f8d7da"; // red
                alertCount++;
            } else {
                tempCard.style.backgroundColor = "#d4edda"; // green
            }

            // Humidity card
            const humCard = document.getElementById('humCard');
            if(latestHum < humMin || latestHum > humMax){
                humCard.style.backgroundColor = "#f8d7da"; // red
                alertCount++;
            } else {
                humCard.style.backgroundColor = "#d4edda"; // green
            }

            // Update alert counter
            document.getElementById('alertCount').textContent = "Current Alerts: " + alertCount;

            // Destroy previous charts
            if(temperatureChart) temperatureChart.destroy();
            if(humidityChart) humidityChart.destroy();

            // Temperature chart
            const ctxTemp = document.getElementById('temperatureChart').getContext('2d');
            temperatureChart = new Chart(ctxTemp, {
                type: 'line',
                data: {
                    labels: data.time,
                    datasets: [{
                        label: 'Temperature (°C)',
                        data: data.temperature,
                        borderColor: 'rgba(255,99,132,1)',
                        backgroundColor: 'rgba(255,99,132,0.2)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: { responsive: true }
            });

            // Humidity chart
            const ctxHum = document.getElementById('humidityChart').getContext('2d');
            humidityChart = new Chart(ctxHum, {
                type: 'line',
                data: {
                    labels: data.time,
                    datasets: [{
                        label: 'Humidity (%)',
                        data: data.humidity,
                        borderColor: 'rgba(54,162,235,1)',
                        backgroundColor: 'rgba(54,162,235,0.2)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: { responsive: true }
            });
        }

        // Initial load
        updateDashboard();

        // Auto-refresh every 15 seconds
        setInterval(updateDashboard, 15000);
    </script>
</body>
</html>

